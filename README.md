Инструмент для создания слепка dev ClickHouse базы из рабочей. Работает по следующему принципу:

- У всех таблиц с партициями формата Ym ('202106', '202112', ....) будут скопированы только последние несколько партиций
  (определяется параметром _monthDepths_).
- Таблицы без партиций, либо с партициями в другом формате, будут перенесены полностью.
- Таблицы без данных (включая движки MySQL и т.п.), либо со старыми партициями, скопированы не будут, так же как не
  создастся автоматически схема (нужно будет выполнить вручную).

## Требования

- PHP 7.4 и выше.

## Установка

- Необходимо установить clickhouse-copier (часть пакета ClickHouse, а если таблицы включают Materialized поля, то на
  июнь 2021 ClickHouse нужно установить из git репозитория) https://clickhouse.tech/docs/ru/getting-started/install/
- Далее обязателен Apache Zookeeper https://zookeeper.apache.org. Если будет установлен из пакетов, то в любом случае
  необходимо скачать и распаковать файлы с официального сайта, т.к. они содержат необходимый файл _zkCli.sh_
- Создаём файл _config/config.php_ по подобию _config/config.php.example_.
- Создаём файл _config/zookeeper.xml_ по подобию _config/zookeeper.xml.example_.

## Запуск

```bash
bin/run.sh
```

Все партиции формата Ym позже текущего месяца скопируются один раз, далее будет перезагружаться партиция только за
текущий месяц (логика в том, что данные из прошлого не дописываются в текущий момент). Во время работы скрипта создаются
задания вида Zookeeper с именем вида _/clickhouse-dev/task0_.

Описания заданий можно узнать командой:

```bash
./zkCli.sh get /clickhouse-dev/task0/description
```

A текущий статус выполнения (поддерживается не всеми версиями clickhouse-copier):

```bash
./zkCli.sh get /clickhouse-dev/task0/status
```

Подобное описание конфигурации доступно на официальном
сайте https://clickhouse.tech/docs/ru/operations/utilities/clickhouse-copier/.

Полезная статья, описывающая весь процесс пользования утилитой _clickhouse-copier_:
https://altinity.com/blog/2018/8/22/clickhouse-copier-in-practice

## Что нужно добавить

- Возможность копирования всей таблицы на постоянной основе (например, аналитику по заказам, которая загружается и в
  прошлое при подключении интеграции к системе).
